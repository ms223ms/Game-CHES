<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„Ø¹Ø¨Ø© Ø§Ù„Ø´Ø·Ø±Ù†Ø¬ - Ø§Ø´ØªØ±Ø§Ùƒ Ø´Ù‡Ø±ÙŠ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 800px;
            width: 100%;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
            font-size: 2rem;
        }

        .status-bar {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .status-bar.warning {
            background: #fff3cd;
            border: 2px solid #ffc107;
        }

        .status-bar.success {
            background: #d4edda;
            border: 2px solid #28a745;
        }

        #chessboard {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 0;
            width: 100%;
            max-width: 600px;
            margin: 0 auto 20px;
            border: 3px solid #333;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .square {
            aspect-ratio: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2.5rem;
            cursor: pointer;
            user-select: none;
            transition: all 0.2s;
        }

        .square.light {
            background: #f0d9b5;
        }

        .square.dark {
            background: #b58863;
        }

        .square.selected {
            background: #7fc97f !important;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.3);
        }

        .square.last-move {
            background: #cdd26a !important;
        }

        .square:hover {
            opacity: 0.8;
        }

        input[type="text"], input[type="email"] {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
        }

        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin: 5px 0;
        }

        button:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }

        .games-remaining {
            font-size: 1.5rem;
            color: #28a745;
            margin: 10px 0;
        }

        .hidden {
            display: none;
        }

        .device-id {
            font-size: 0.8rem;
            color: #666;
            word-break: break-all;
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .room-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
        }

        .room-code {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1976d2;
            margin: 10px 0;
        }

        .players-list {
            display: flex;
            justify-content: space-around;
            margin: 15px 0;
        }

        .player-box {
            padding: 10px 20px;
            border-radius: 8px;
            background: white;
            border: 2px solid #ddd;
        }

        .player-box.active {
            border-color: #28a745;
            background: #d4edda;
        }

        .subscription-panel {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .payment-info {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 2px dashed #007bff;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 1.2rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>â™” Ù„Ø¹Ø¨Ø© Ø§Ù„Ø´Ø·Ø±Ù†Ø¬ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© â™š</h1>
        
        <div id="loadingDiv" class="loading hidden">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>

        <!-- Login Panel -->
        <div id="loginPanel">
            <div class="status-bar">
                <h3>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
                <p>Ø£Ø¯Ø®Ù„ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ù„Ø¨Ø¯Ø¡</p>
            </div>
            <input type="email" id="emailInput" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" required>
            <button id="loginBtn">Ø¯Ø®ÙˆÙ„</button>
            <div class="device-id" id="deviceIdLogin"></div>
        </div>

        <!-- Game Panel -->
        <div id="gamePanel" class="hidden">
            <div id="statusBar" class="status-bar">
                <div class="games-remaining">Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©: <span id="gamesLeft">4</span></div>
                <div id="userEmail"></div>
                <div class="device-id" id="deviceIdGame"></div>
            </div>

            <!-- Room Selection -->
            <div id="roomSelection">
                <input type="text" id="roomInput" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„ØºØ±ÙØ© Ø£Ùˆ Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºØ§Ù‹ Ù„Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ©" maxlength="6">
                <button id="joinBtn">Ø§Ù†Ø¶Ù…Ø§Ù… / Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ©</button>
            </div>

            <!-- Game Area -->
            <div id="gameArea" class="hidden">
                <div class="room-info">
                    <div>Ø±Ù‚Ù… Ø§Ù„ØºØ±ÙØ©:</div>
                    <div class="room-code" id="roomCode"></div>
                    <div style="font-size: 0.9rem; color: #666;">Ø´Ø§Ø±Ùƒ Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… Ù„Ù„Ø¹Ø¨ Ù…Ø¹ ØµØ¯ÙŠÙ‚Ùƒ</div>
                </div>

                <div class="players-list">
                    <div class="player-box" id="whitePlayer">
                        <div>âšª Ø£Ø¨ÙŠØ¶</div>
                        <div id="whiteEmail">Ø§Ù†ØªØ¸Ø§Ø±...</div>
                    </div>
                    <div class="player-box" id="blackPlayer">
                        <div>âš« Ø£Ø³ÙˆØ¯</div>
                        <div id="blackEmail">Ø§Ù†ØªØ¸Ø§Ø±...</div>
                    </div>
                </div>

                <div id="chessboard"></div>
                
                <button id="resetBtn" class="btn-danger">Ù„Ø¹Ø¨Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
                <button id="leaveBtn" class="btn-danger">Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØºØ±ÙØ©</button>
            </div>

            <!-- Subscription Panel -->
            <div id="subscriptionPanel" class="subscription-panel hidden">
                <h3>âš ï¸ Ø§Ù†ØªÙ‡Øª Ø£Ù„Ø¹Ø§Ø¨Ùƒ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ©!</h3>
                <p>Ù„Ù‚Ø¯ Ù„Ø¹Ø¨Øª 4 Ø£Ù„Ø¹Ø§Ø¨. Ù„Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø±ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ø´Ù‡Ø±ÙŠ.</p>
                
                <div class="payment-info">
                    <h4>ğŸ’³ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¯ÙØ¹ Ø¹Ø¨Ø± Instapay:</h4>
                    <p><strong>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</strong> 01120194940</p>
                    <p><strong>Ø§Ù„Ù…Ø¨Ù„Øº:</strong> 100 Ø¬Ù†ÙŠÙ‡ Ù…ØµØ±ÙŠ Ø´Ù‡Ø±ÙŠØ§Ù‹</p>
                    <p><strong>Ù…Ù„Ø§Ø­Ø¸Ø©:</strong> Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­ÙˆÙŠÙ„ØŒ Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© Ø£Ø¯Ù†Ø§Ù‡</p>
                </div>

                <input type="text" id="transactionInput" placeholder="Ø±Ù‚Ù… Ù…Ø¹Ø§Ù…Ù„Ø© Instapay">
                <button id="verifyBtn" class="btn-success">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯ÙØ¹</button>
            </div>

            <button id="logoutBtn" class="btn-danger">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
        </div>
    </div>

   <script>
    // ============ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª JSONBin ============
    const JSONBIN_API_KEY = '$2a$10$MUgieOcdv8QNyPRuRsFb6eaAOYcAzxuWL6TB6FbI8L7fhZIVVibdO';
    const JSONBIN_BIN_ID = '6910992143b1c97be9a29d04';
    const JSONBIN_URL = `https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`;

    // ============ Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø© ============
    let currentUser = null;
    let deviceId = null;
    let currentRoom = null;
    let playerColor = null;
    let gameData = { users: {}, rooms: {}, paymentVerifications: {} };
    let updateInterval = null;

    let gameState = {
        board: [],
        currentTurn: 'white',
        selectedPiece: null,
        lastMove: null
    };

    // ============ Device Fingerprint ============
    function generateDeviceFingerprint() {
        try {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            ctx.textBaseline = "top";
            ctx.font = "14px Arial";
            ctx.fillStyle = "#f60";
            ctx.fillRect(125,1,62,20);
            ctx.fillStyle = "#069";
            ctx.fillText("Chess", 2, 15);
            const canvasData = canvas.toDataURL();

            const fp = {
                ua: navigator.userAgent,
                lang: navigator.language,
                platform: navigator.platform,
                screen: `${screen.width}x${screen.height}`,
                tz: Intl.DateTimeFormat().resolvedOptions().timeZone,
                canvas: canvasData.substring(0, 50)
            };

            let hash = 0;
            const str = JSON.stringify(fp);
            for (let i = 0; i < str.length; i++) {
                hash = ((hash << 5) - hash) + str.charCodeAt(i);
                hash = hash & hash;
            }
            return 'dev_' + Math.abs(hash).toString(36);
        } catch(e) {
            return 'dev_' + Math.random().toString(36).substr(2, 12);
        }
    }

    // ============ UI Functions ============
    function showLoading(msg) {
        const div = document.getElementById('loadingDiv');
        div.textContent = msg || 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...';
        div.classList.remove('hidden');
    }

    function hideLoading() {
        document.getElementById('loadingDiv').classList.add('hidden');
    }

    // ============ JSONBin API ============
    async function loadData() {
        try {
            const res = await fetch(JSONBIN_URL + '/latest', {
                headers: { 'X-Master-Key': JSONBIN_API_KEY }
            });
            if (!res.ok) throw new Error('ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„');
            const data = await res.json();
            gameData = data.record || { users: {}, rooms: {}, paymentVerifications: {} };
            return gameData;
        } catch (e) {
            console.error('Ø®Ø·Ø£:', e);
            return { users: {}, rooms: {}, paymentVerifications: {} };
        }
    }

    async function saveData() {
  try {
    const response = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
      method: "PUT",
      headers: {
        "Content-Type": "application/json",
        "X-Master-Key": ACCESS_KEY
      },
      body: JSON.stringify(gameData)
    });

    if (!response.ok) {
      console.error("âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸:", response.status, response.statusText);
      alert("âš ï¸ Ù„Ù… ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŒ ØªØ­Ù‚Ù‚ Ù…Ù† BIN_ID Ø£Ùˆ ACCESS_KEY");
    } else {
      console.log("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ JSONBin");
    }
  } catch (error) {
    console.error("âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ JSONBin:", error);
    alert("ğŸš¨ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±");
  }
}


    // ============ Authentication ============
    async function login() {
        const email = document.getElementById('emailInput').value.trim();
        if (!email || !email.includes('@')) {
            alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØµØ­ÙŠØ­');
            return;
        }

        showLoading('Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...');
        await loadData();

        if (gameData.users[deviceId]) {
            const userData = gameData.users[deviceId];
            if (userData.email !== email) {
                alert(`âŒ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø² Ù…Ø³Ø¬Ù„ Ø¨Ù€: ${userData.email}\nÙ„Ø§ ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø³Ø§Ø¨!`);
                hideLoading();
                return;
            }
            currentUser = userData;
        } else {
            currentUser = {
                email,
                deviceId,
                gamesPlayed: 0,
                subscribed: false,
                subscriptionDate: null,
                createdAt: Date.now()
            };
            gameData.users[deviceId] = currentUser;
            await saveData();
        }

        checkSubscription();
        showGamePanel();
        hideLoading();
    }

    function showGamePanel() {
        document.getElementById('loginPanel').classList.add('hidden');
        document.getElementById('gamePanel').classList.remove('hidden');
        document.getElementById('userEmail').textContent = 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ' + currentUser.email;
        document.getElementById('deviceIdGame').textContent = 'Ù…Ø¹Ø±Ù Ø§Ù„Ø¬Ù‡Ø§Ø²: ' + deviceId;
        updateGamesDisplay();
    }

    function logout() {
        if (currentRoom) leaveRoom();
        currentUser = null;
        currentRoom = null;
        document.getElementById('loginPanel').classList.remove('hidden');
        document.getElementById('gamePanel').classList.add('hidden');
    }

    // ============ Subscription ============
    function checkSubscription() {
        if (currentUser.subscribed) {
            const now = Date.now();
            const oneMonth = 30 * 24 * 60 * 60 * 1000;
            if (now - currentUser.subscriptionDate > oneMonth) {
                currentUser.subscribed = false;
                gameData.users[deviceId].subscribed = false;
                saveData();
            }
        }

        if (!currentUser.subscribed && currentUser.gamesPlayed >= 4) {
            showSubscriptionPanel();
        }
    }

    function showSubscriptionPanel() {
        document.getElementById('subscriptionPanel').classList.remove('hidden');
        document.getElementById('gameArea').classList.add('hidden');
        document.getElementById('roomSelection').classList.add('hidden');
    }

    async function verifyPayment() {
        const txn = document.getElementById('transactionInput').value.trim();
        if (!txn) {
            alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©');
            return;
        }

        gameData.paymentVerifications[deviceId] = {
            deviceId,
            email: currentUser.email,
            transaction: txn,
            timestamp: Date.now(),
            status: 'pending'
        };
        await saveData();

        alert('âœ… ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„!\nØ³ÙŠØªÙ… Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø®Ù„Ø§Ù„ 24 Ø³Ø§Ø¹Ø©.');
        document.getElementById('transactionInput').value = '';
    }

    function updateGamesDisplay() {
        const left = currentUser.subscribed ? 'âˆ' : Math.max(0, 4 - currentUser.gamesPlayed);
        document.getElementById('gamesLeft').textContent = left;

        const bar = document.getElementById('statusBar');
        if (currentUser.subscribed) {
            bar.classList.add('success');
            bar.classList.remove('warning');
        } else if (currentUser.gamesPlayed >= 3) {
            bar.classList.add('warning');
        }
    }

    // ============ Rooms ============
    async function joinRoom() {
    if (!currentUser.subscribed && currentUser.gamesPlayed >= 4) {
        showSubscriptionPanel();
        return;
    }

    let roomId = document.getElementById('roomInput').value.trim().toUpperCase();
    if (!roomId) {
        roomId = Math.random().toString(36).substr(2, 6).toUpperCase();
    }

    showLoading('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…...');
    await loadData();

    // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ© Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
    if (!gameData.rooms[roomId]) {
        initializeBoard();
        gameData.rooms[roomId] = {
            board: gameState.board,
            currentTurn: 'white',
            players: {},
            createdAt: Date.now()
        };
        playerColor = 'white'; // Ø£ÙˆÙ„ Ù„Ø§Ø¹Ø¨ = Ø£Ø¨ÙŠØ¶
    } else {
        const room = gameData.rooms[roomId];
        if (!room.players) room.players = {};

        // Ø¥Ø°Ø§ Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ù„ÙˆÙ†Ù‡
        if (room.players[deviceId]) {
            playerColor = room.players[deviceId].color;
        } else {
            // ØªØ­Ø¯ÙŠØ¯ Ù„ÙˆÙ† Ø¬Ø¯ÙŠØ¯ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ÙŠÙ†
            const colorsInUse = Object.values(room.players).map(p => p.color);
            if (!colorsInUse.includes('white')) {
                playerColor = 'white';
            } else if (!colorsInUse.includes('black')) {
                playerColor = 'black';
            } else {
                alert('âŒ Ø§Ù„ØºØ±ÙØ© Ù…Ù…ØªÙ„Ø¦Ø©!');
                hideLoading();
                return;
            }
        }

        // Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        gameState.board = room.board;
        gameState.currentTurn = room.currentTurn;
    }

    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù„Ø§Ø¹Ø¨ ÙˆØ­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡ ÙÙˆØ±Ù‹Ø§ Ø­ØªÙ‰ Ù„Ø§ ÙŠØ¯Ø®Ù„ Ù„Ø§Ø¹Ø¨ Ø¢Ø®Ø± Ø¨Ù†ÙØ³ Ø§Ù„Ù„ÙˆÙ†
    gameData.rooms[roomId].players[deviceId] = {
        email: currentUser.email,
        color: playerColor,
        joinedAt: Date.now(),
        lastSeen: Date.now()
    };
    await saveData();

    currentRoom = roomId;

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    document.getElementById('roomSelection').classList.add('hidden');
    document.getElementById('gameArea').classList.remove('hidden');
    document.getElementById('roomCode').textContent = roomId;

    renderBoard();
    updatePlayersList();
    hideLoading();
    startAutoUpdate();
}


    async function leaveRoom() {
        if (currentRoom) {
            stopAutoUpdate();
            await loadData();

            if (gameData.rooms[currentRoom]) {
                delete gameData.rooms[currentRoom].players[deviceId];
                if (Object.keys(gameData.rooms[currentRoom].players).length === 0) {
                    delete gameData.rooms[currentRoom];
                }
                await saveData();
            }

            currentRoom = null;
            playerColor = null;
            document.getElementById('gameArea').classList.add('hidden');
            document.getElementById('roomSelection').classList.remove('hidden');
        }
    }

    function startAutoUpdate() {
        stopAutoUpdate();
        updateInterval = setInterval(async () => {
            if (currentRoom) {
                await loadData();
                if (gameData.rooms[currentRoom]) {
                    const room = gameData.rooms[currentRoom];
                    gameState.board = room.board;
                    gameState.currentTurn = room.currentTurn;
                    renderBoard();
                    updatePlayersList();
                }
            }
        }, 3000);
    }

    function stopAutoUpdate() {
        if (updateInterval) {
            clearInterval(updateInterval);
            updateInterval = null;
        }
    }

    function updatePlayersList() {
        if (!currentRoom || !gameData.rooms[currentRoom]) return;

        const players = gameData.rooms[currentRoom].players;
        let white = 'Ø§Ù†ØªØ¸Ø§Ø±...';
        let black = 'Ø§Ù†ØªØ¸Ø§Ø±...';

        Object.values(players).forEach(p => {
            const name = p.email.split('@')[0];
            if (p.color === 'white') white = name;
            if (p.color === 'black') black = name;
        });

        document.getElementById('whiteEmail').textContent = white;
        document.getElementById('blackEmail').textContent = black;

        document.getElementById('whitePlayer').classList.toggle('active', gameState.currentTurn === 'white');
        document.getElementById('blackPlayer').classList.toggle('active', gameState.currentTurn === 'black');
    }

    // ============ Chess Logic ============
    function initializeBoard() {
        gameState.board = [
            ['â™œ','â™','â™','â™›','â™š','â™','â™','â™œ'],
            ['â™Ÿ','â™Ÿ','â™Ÿ','â™Ÿ','â™Ÿ','â™Ÿ','â™Ÿ','â™Ÿ'],
            ['','','','','','','',''],
            ['','','','','','','',''],
            ['','','','','','','',''],
            ['','','','','','','',''],
            ['â™™','â™™','â™™','â™™','â™™','â™™','â™™','â™™'],
            ['â™–','â™˜','â™—','â™•','â™”','â™—','â™˜','â™–']
        ];
        gameState.currentTurn = 'white';
        gameState.selectedPiece = null;
        gameState.lastMove = null;
    }

    function renderBoard() {
        const board = document.getElementById('chessboard');
        board.innerHTML = '';

        for (let r = 0; r < 8; r++) {
            for (let c = 0; c < 8; c++) {
                const sq = document.createElement('div');
                sq.className = 'square ' + ((r + c) % 2 === 0 ? 'light' : 'dark');

                if (gameState.lastMove &&
                    ((gameState.lastMove.from[0] === r && gameState.lastMove.from[1] === c) ||
                     (gameState.lastMove.to[0] === r && gameState.lastMove.to[1] === c))) {
                    sq.classList.add('last-move');
                }

                if (gameState.selectedPiece &&
                    gameState.selectedPiece[0] === r && gameState.selectedPiece[1] === c) {
                    sq.classList.add('selected');
                }

                sq.textContent = gameState.board[r][c];
                sq.onclick = () => handleSquareClick(r, c);
                board.appendChild(sq);
            }
        }
    }

    async function handleSquareClick(r, c) {
        if (gameState.currentTurn !== playerColor) {
            alert('â³ Ø§Ù†ØªØ¸Ø± Ø¯ÙˆØ±Ùƒ!');
            return;
        }

        const piece = gameState.board[r][c];

        if (gameState.selectedPiece) {
            const [fr, fc] = gameState.selectedPiece;
            const mp = gameState.board[fr][fc];

            if (isValidMove(fr, fc, r, c, mp)) {
                gameState.board[r][c] = mp;
                gameState.board[fr][fc] = '';
                gameState.lastMove = { from: [fr, fc], to: [r, c] };
                gameState.currentTurn = gameState.currentTurn === 'white' ? 'black' : 'white';
                gameState.selectedPiece = null;

                await loadData();
                if (gameData.rooms[currentRoom]) {
                    gameData.rooms[currentRoom].board = gameState.board;
                    gameData.rooms[currentRoom].currentTurn = gameState.currentTurn;
                    await saveData();
                }

                if (!currentUser.subscribed) {
                    currentUser.gamesPlayed++;
                    gameData.users[deviceId].gamesPlayed = currentUser.gamesPlayed;
                    await saveData();
                    updateGamesDisplay();
                    checkSubscription();
                }

                renderBoard();
            } else {
                gameState.selectedPiece = null;
                renderBoard();
            }
        } else if (piece && isPieceColor(piece, playerColor)) {
            gameState.selectedPiece = [r, c];
            renderBoard();
        }
    }

    function isPieceColor(piece, color) {
        const white = 'â™”â™•â™–â™—â™˜â™™';
        const black = 'â™šâ™›â™œâ™â™â™Ÿ';
        return color === 'white' ? white.includes(piece) : black.includes(piece);
    }

    function isValidMove(fr, fc, tr, tc, piece) {
        if (fr === tr && fc === tc) return false;
        const target = gameState.board[tr][tc];
        if (target && isPieceColor(target, playerColor)) return false;
        return true;
    }

    async function resetGame() {
        if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¨Ø¯Ø¡ Ù„Ø¹Ø¨Ø© Ø¬Ø¯ÙŠØ¯Ø©ØŸ')) return;

        initializeBoard();
        if (currentRoom) {
            await loadData();
            if (gameData.rooms[currentRoom]) {
                gameData.rooms[currentRoom].board = gameState.board;
                gameData.rooms[currentRoom].currentTurn = 'white';
                await saveData();
            }
        }
        renderBoard();
    }

    // ============ Event Listeners ============
    window.addEventListener('DOMContentLoaded', () => {
        deviceId = generateDeviceFingerprint();
        document.getElementById('deviceIdLogin').textContent = 'Ù…Ø¹Ø±Ù Ø§Ù„Ø¬Ù‡Ø§Ø²: ' + deviceId;

        document.getElementById('loginBtn').addEventListener('click', login);
        document.getElementById('joinBtn').addEventListener('click', joinRoom);
        document.getElementById('leaveBtn').addEventListener('click', leaveRoom);
        document.getElementById('resetBtn').addEventListener('click', resetGame);
        document.getElementById('logoutBtn').addEventListener('click', logout);
        document.getElementById('verifyBtn').addEventListener('click', verifyPayment);

        document.getElementById('emailInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') login();
        });
    });
</script>

</body>
</html>






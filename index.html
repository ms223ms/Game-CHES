<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù„Ø¹Ø¨Ø© Ø§Ù„Ø´Ø·Ø±Ù†Ø¬ - Ø§Ø´ØªØ±Ø§Ùƒ Ø´Ù‡Ø±ÙŠ</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:Arial,sans-serif;background:#1a1a1a;display:flex;justify-content:center;align-items:center;min-height:100vh;}
.container{background:white;border-radius:20px;padding:20px;max-width:900px;width:95%;box-shadow:0 20px 60px rgba(0,0,0,0.3);}
h1{text-align:center;color:#333;margin-bottom:15px;font-size:2rem;}
.status-bar{background:#f8f9fa;padding:10px;border-radius:10px;margin-bottom:15px;text-align:center;}
.status-bar.warning{background:#fff3cd;border:2px solid #ffc107;}
.status-bar.success{background:#d4edda;border:2px solid #28a745;}
#chessboard{display:grid;grid-template-columns:repeat(8,1fr);gap:2px;width:90vw;max-width:480px;aspect-ratio:1/1;margin:0 auto 10px auto;}
.square{display:flex;justify-content:center;align-items:center;font-size:calc(10vw/8);font-weight:bold;cursor:pointer;border-radius:8px;box-shadow:0 4px 8px rgba(0,0,0,0.4);transition:all 0.2s;}
.square.light{background:#f0d9b5;}
.square.dark{background:#b58863;}
.square.selected{box-shadow:0 0 15px 3px #ff0 inset;}
.square.last-move{background:#cdd26a !important;}
.square:hover{transform:translateZ(20px);}
button{padding:10px 15px;margin:5px;border:none;border-radius:6px;background:#007bff;color:white;cursor:pointer;}
button:hover{background:#0056b3;}
.btn-danger{background:#dc3545;}
.btn-danger:hover{background:#c82333;}
.btn-success{background:#28a745;}
.btn-success:hover{background:#218838;}
.games-remaining{font-size:1.2rem;color:#28a745;margin:5px 0;}
.hidden{display:none;}
.device-id{font-size:0.8rem;color:#666;word-break:break-all;margin:5px 0;padding:5px;background:#f8f9fa;border-radius:5px;}
.room-info{background:#e3f2fd;padding:10px;border-radius:8px;margin:10px 0;text-align:center;}
.room-code{font-size:1.3rem;font-weight:bold;color:#1976d2;margin:5px 0;}
#playersPanel{display:flex;justify-content:space-between;width:90vw;max-width:480px;margin-bottom:10px;}
.player{padding:5px 10px;border-radius:6px;background:#222;color:#fff;box-shadow:0 4px 8px rgba(0,0,0,0.5);text-align:center;min-width:80px;}
.players-list{display:flex;justify-content:space-around;margin:10px 0;}
.player-box{padding:8px 15px;border-radius:8px;background:white;border:2px solid #ddd;}
.player-box.active{border-color:#28a745;background:#d4edda;}
.subscription-panel{background:#f8f9fa;padding:15px;border-radius:10px;margin-top:10px;}
.payment-info{background:white;padding:10px;border-radius:8px;margin:10px 0;border:2px dashed #007bff;}
.loading{text-align:center;padding:15px;color:#666;font-size:1.1rem;}
#gameArea{display:flex;flex-direction:column;align-items:center;}
input[type=text],input[type=email]{width:100%;padding:10px;margin:8px 0;border:2px solid #ddd;border-radius:8px;font-size:1rem;}
</style>
</head>
<body>
<div class="container">
<h1>â™” Ù„Ø¹Ø¨Ø© Ø§Ù„Ø´Ø·Ø±Ù†Ø¬ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© â™š</h1>
<div id="loadingDiv" class="loading hidden">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>

<!-- Login -->
<div id="loginPanel">
<div class="status-bar"><h3>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3><p>Ø£Ø¯Ø®Ù„ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ù„Ø¨Ø¯Ø¡</p></div>
<input type="email" id="emailInput" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" required>
<button id="loginBtn">Ø¯Ø®ÙˆÙ„</button>
<div class="device-id" id="deviceIdLogin"></div>
</div>

<!-- Game Panel -->
<div id="gamePanel" class="hidden">
<div id="statusBar" class="status-bar">
<div class="games-remaining">Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©: <span id="gamesLeft">4</span></div>
<div id="userEmail"></div>
<div class="device-id" id="deviceIdGame"></div>
</div>

<div id="roomSelection">
<input type="text" id="roomInput" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„ØºØ±ÙØ© Ø£Ùˆ Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºØ§Ù‹ Ù„Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ©" maxlength="6">
<button id="joinBtn">Ø§Ù†Ø¶Ù…Ø§Ù… / Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ©</button>
</div>

<div id="gameArea" class="hidden">
<div class="room-info">
<div>Ø±Ù‚Ù… Ø§Ù„ØºØ±ÙØ©:</div>
<div class="room-code" id="roomCode"></div>
<div style="font-size:0.8rem;color:#666;">Ø´Ø§Ø±Ùƒ Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… Ù„Ù„Ø¹Ø¨ Ù…Ø¹ ØµØ¯ÙŠÙ‚Ùƒ</div>
</div>

<div class="players-list">
<div class="player-box" id="whitePlayer"><div>âšª Ø£Ø¨ÙŠØ¶</div><div id="whiteEmail">Ø§Ù†ØªØ¸Ø§Ø±...</div></div>
<div class="player-box" id="blackPlayer"><div>âš« Ø£Ø³ÙˆØ¯</div><div id="blackEmail">Ø§Ù†ØªØ¸Ø§Ø±...</div></div>
</div>

<div id="chessboard"></div>

<button id="resetBtn" class="btn-danger">Ù„Ø¹Ø¨Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
<button id="leaveBtn" class="btn-danger">Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØºØ±ÙØ©</button>
</div>

<div id="subscriptionPanel" class="subscription-panel hidden">
<h3>âš ï¸ Ø§Ù†ØªÙ‡Øª Ø£Ù„Ø¹Ø§Ø¨Ùƒ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ©!</h3>
<p>Ù„Ù‚Ø¯ Ù„Ø¹Ø¨Øª 4 Ø£Ù„Ø¹Ø§Ø¨. Ù„Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø±ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ø´Ù‡Ø±ÙŠ.</p>
<div class="payment-info">
<h4>ğŸ’³ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¯ÙØ¹ Ø¹Ø¨Ø± Instapay:</h4>
<p><strong>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</strong> 01120194940</p>
<p><strong>Ø§Ù„Ù…Ø¨Ù„Øº:</strong> 100 Ø¬Ù†ÙŠÙ‡ Ù…ØµØ±ÙŠ Ø´Ù‡Ø±ÙŠØ§Ù‹</p>
<p><strong>Ù…Ù„Ø§Ø­Ø¸Ø©:</strong> Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­ÙˆÙŠÙ„ØŒ Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© Ø£Ø¯Ù†Ø§Ù‡</p>
</div>
<input type="text" id="transactionInput" placeholder="Ø±Ù‚Ù… Ù…Ø¹Ø§Ù…Ù„Ø© Instapay">
<button id="verifyBtn" class="btn-success">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯ÙØ¹</button>
</div>

<button id="logoutBtn" class="btn-danger">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
</div>
</div>

<script>
// ===== Ù…ØªØºÙŠØ±Ø§Øª Ùˆ JSONBin =====
const JSONBIN_API_KEY='$2a$10$MUgieOcdv8QNyPRuRsFb6eaAOYcAzxuWL6TB6FbI8L7fhZIVVibdO';
const JSONBIN_BIN_ID='6911aa09ae596e708f4fdd18';
const JSONBIN_URL=`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`;
let currentUser=null,deviceId=null,currentRoom=null,playerColor=null;
let gameData={users:{},rooms:{},paymentVerifications:{}},updateInterval=null;
let gameState={board:[],currentTurn:'white',selectedPiece:null,lastMove:null};

// ===== Device ID =====
function generateDeviceFingerprint(){
    try{
        const canvas=document.createElement('canvas'),ctx=canvas.getContext('2d');
        ctx.font="14px Arial"; ctx.fillStyle="#f60"; ctx.fillRect(125,1,62,20); ctx.fillStyle="#069"; ctx.fillText("Chess",2,15);
        const canvasData=canvas.toDataURL();
        const fp={ua:navigator.userAgent,lang:navigator.language,platform:navigator.platform,screen:`${screen.width}x${screen.height}`,tz:Intl.DateTimeFormat().resolvedOptions().timeZone,canvas:canvasData.substring(0,50)};
        let hash=0,str=JSON.stringify(fp);
        for(let i=0;i<str.length;i++){hash=((hash<<5)-hash)+str.charCodeAt(i);hash=hash&hash;}
        return 'dev_'+Math.abs(hash).toString(36);
    }catch(e){ return 'dev_'+Math.random().toString(36).substr(2,12);}
}

// ===== UI =====
function showLoading(msg){ const div=document.getElementById('loadingDiv'); div.textContent=msg||'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...'; div.classList.remove('hidden'); }
function hideLoading(){ document.getElementById('loadingDiv').classList.add('hidden'); }

// ===== JSONBin =====
async function loadData(){ try{ const res=await fetch(JSONBIN_URL+'/latest',{headers:{'X-Master-Key':JSONBIN_API_KEY}}); if(!res.ok) throw new Error('ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„'); const data=await res.json(); gameData=data.record||{users:{},rooms:{},paymentVerifications:{}}; return gameData;}catch(e){console.error(e); return {users:{},rooms:{},paymentVerifications:{}};} }
async function saveData(){ try{ await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`,{method:"PUT",headers:{"Content-Type":"application/json","X-Master-Key":JSONBIN_API_KEY},body:JSON.stringify(gameData)});}catch(e){console.error(e);}}

// ===== Login =====
async function login(){
    const email=document.getElementById('emailInput').value.trim();
    if(!email.includes('@')){ alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØµØ­ÙŠØ­'); return; }
    showLoading('Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...'); await loadData();
    if(gameData.users[deviceId]){ const userData=gameData.users[deviceId]; if(userData.email!==email){ alert(`âŒ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø² Ù…Ø³Ø¬Ù„ Ø¨Ù€: ${userData.email}`); hideLoading(); return; } currentUser=userData; } 
    else{ currentUser={email,deviceId,gamesPlayed:0,subscribed:false,subscriptionDate:null,createdAt:Date.now()}; gameData.users[deviceId]=currentUser; await saveData(); }
    checkSubscription(); showGamePanel(); hideLoading();
}
function showGamePanel(){ document.getElementById('loginPanel').classList.add('hidden'); document.getElementById('gamePanel').classList.remove('hidden'); document.getElementById('userEmail').textContent='Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: '+currentUser.email; document.getElementById('deviceIdGame').textContent='Ù…Ø¹Ø±Ù Ø§Ù„Ø¬Ù‡Ø§Ø²: '+deviceId; updateGamesDisplay();}
function logout(){ if(currentRoom) leaveRoom(); currentUser=null; currentRoom=null; document.getElementById('loginPanel').classList.remove('hidden'); document.getElementById('gamePanel').classList.add('hidden'); }

// ===== Subscription =====
function checkSubscription(){ if(currentUser.subscribed && currentUser.subscriptionDate){ const now=Date.now(),oneMonth=30*24*60*60*1000; if(now-currentUser.subscriptionDate>oneMonth){ currentUser.subscribed=false; gameData.users[deviceId].subscribed=false; saveData(); } } if(!currentUser.subscribed && currentUser.gamesPlayed>=4){ showSubscriptionPanel(); } }
function showSubscriptionPanel(){ document.getElementById('subscriptionPanel').classList.remove('hidden'); document.getElementById('gameArea').classList.add('hidden'); document.getElementById('roomSelection').classList.add('hidden'); }
async function verifyPayment(){ const txn=document.getElementById('transactionInput').value.trim(); if(!txn){ alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©'); return; } gameData.paymentVerifications[deviceId]={deviceId,email:currentUser.email,transaction:txn,timestamp:Date.now(),status:'pending'}; await saveData(); alert('âœ… ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„!'); document.getElementById('transactionInput').value=''; }
function updateGamesDisplay(){ const left=currentUser.subscribed?'âˆ':Math.max(0,4-currentUser.gamesPlayed); document.getElementById('gamesLeft').textContent=left; const bar=document.getElementById('statusBar'); if(currentUser.subscribed){ bar.classList.add('success'); bar.classList.remove('warning'); } else if(currentUser.gamesPlayed>=3){ bar.classList.add('warning'); } }

// ===== Rooms & Auto Update =====
async function joinRoom(){ if(!currentUser.subscribed && currentUser.gamesPlayed>=4){ showSubscriptionPanel(); return; } let roomId=document.getElementById('roomInput').value.trim().toUpperCase(); if(!roomId) roomId=Math.random().toString(36).substr(2,6).toUpperCase(); showLoading('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…...'); await loadData(); if(!gameData.rooms[roomId]){ initializeBoard(); gameData.rooms[roomId]={board:gameState.board,currentTurn:'white',players:{},createdAt:Date.now()}; playerColor='white'; } else{ const room=gameData.rooms[roomId]; if(!room.players) room.players={}; if(room.players[deviceId]) playerColor=room.players[deviceId].color; else{ const colorsInUse=Object.values(room.players).map(p=>p.color); playerColor=!colorsInUse.includes('white')?'white':(!colorsInUse.includes('black')?'black':null); if(!playerColor){ alert('âŒ Ø§Ù„ØºØ±ÙØ© Ù…Ù…ØªÙ„Ø¦Ø©!'); hideLoading(); return; } } gameState.board=room.board; gameState.currentTurn=room.currentTurn; } gameData.rooms[roomId].players[deviceId]={email:currentUser.email,color:playerColor,joinedAt:Date.now(),lastSeen:Date.now()}; await saveData(); currentRoom=roomId; document.getElementById('roomSelection').classList.add('hidden'); document.getElementById('gameArea').classList.remove('hidden'); document.getElementById('roomCode').textContent=roomId; renderBoard(); updatePlayersList(); hideLoading(); startAutoUpdate(); }
async function leaveRoom(){ if(currentRoom){ stopAutoUpdate(); await loadData(); if(gameData.rooms[currentRoom]){ delete gameData.rooms[currentRoom].players[deviceId]; if(Object.keys(gameData.rooms[currentRoom].players).length===0) delete gameData.rooms[currentRoom]; await saveData(); } currentRoom=null; playerColor=null; document.getElementById('gameArea').classList.add('hidden'); document.getElementById('roomSelection').classList.remove('hidden'); } }
function startAutoUpdate(){ stopAutoUpdate(); updateInterval=setInterval(async()=>{ if(currentRoom){ await loadData(); if(gameData.rooms[currentRoom]){ const room=gameData.rooms[currentRoom]; gameState.board=room.board; gameState.currentTurn=room.currentTurn; renderBoard(); updatePlayersList(); } } },3000);}
function stopAutoUpdate(){ if(updateInterval) clearInterval(updateInterval);}
function updatePlayersList(){ if(!currentRoom || !gameData.rooms[currentRoom]) return; const room=gameData.rooms[currentRoom]; const white=document.getElementById('whiteEmail'), black=document.getElementById('blackEmail'); white.textContent='Ø§Ù†ØªØ¸Ø§Ø±...'; black.textContent='Ø§Ù†ØªØ¸Ø§Ø±...'; Object.values(room.players).forEach(p=>{ if(p.color==='white') white.textContent=p.email; else if(p.color==='black') black.textContent=p.email; }); }

// ===== Chess Logic =====
function initializeBoard(){ gameState.board=[['r','n','b','q','k','b','n','r'],['p','p','p','p','p','p','p','p'],['','','','','','','',''],['','','','','','','',''],['','','','','','','',''],['','','','','','','',''],['P','P','P','P','P','P','P','P'],['R','N','B','Q','K','B','N','R']]; gameState.currentTurn='white'; gameState.selectedPiece=null; gameState.lastMove=null; }
function renderBoard(){ const boardDiv=document.getElementById('chessboard'); boardDiv.innerHTML=''; for(let r=0;r<8;r++){ for(let c=0;c<8;c++){ const square=document.createElement('div'); square.classList.add('square',(r+c)%2===0?'light':'dark'); if(gameState.selectedPiece && gameState.selectedPiece[0]===r && gameState.selectedPiece[1]===c) square.classList.add('selected'); if(gameState.lastMove && ((gameState.lastMove.from[0]===r && gameState.lastMove.from[1]===c) || (gameState.lastMove.to[0]===r && gameState.lastMove.to[1]===c))) square.classList.add('last-move'); square.textContent=pieceToUnicode(gameState.board[r][c]); square.addEventListener('click',()=>handleSquareClick(r,c)); boardDiv.appendChild(square);} } }
function pieceToUnicode(piece){ switch(piece){case 'K':return 'â™”';case 'Q':return 'â™•';case 'R':return 'â™–';case 'B':return 'â™—';case 'N':return 'â™˜';case 'P':return 'â™™';case 'k':return 'â™š';case 'q':return 'â™›';case 'r':return 'â™œ';case 'b':return 'â™';case 'n':return 'â™';case 'p':return 'â™Ÿ';default:return '';}}
function isPieceColor(piece,color){ if(!piece) return false; if(color==='white') return piece>='A'&&piece<='Z'; return piece>='a'&&piece<='z'; }

// ==== Events ====
document.getElementById('loginBtn').addEventListener('click',login);
document.getElementById('joinBtn').addEventListener('click',joinRoom);
document.getElementById('leaveBtn').addEventListener('click',leaveRoom);
document.getElementById('resetBtn').addEventListener('click',()=>{ if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©ØŸ')){ initializeBoard(); renderBoard(); if(currentRoom) saveMove(); }});
document.getElementById('logoutBtn').addEventListener('click',logout);
document.getElementById('verifyBtn').addEventListener('click',verifyPayment);

// ==== Initialization ====
deviceId=generateDeviceFingerprint();
document.getElementById('deviceIdLogin').textContent='Ù…Ø¹Ø±Ù Ø§Ù„Ø¬Ù‡Ø§Ø²: '+deviceId;
initializeBoard();
</script>
</body>
</html>
